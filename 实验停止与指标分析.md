# 通用语种对抗扰动：运行停止原因与日志数值解读

## 实验为何在 epoch 100 停止
- 训练循环由 `UniversalWhisperLanguageAttack._compute_universal_perturbation` 中的 `epoch_iter` 驱动，`epoch_iter` 直接遍历 `epoch_counter`。`epoch_counter` 的上限来自命令行或 YAML 的 `epochs` 设置（通过 `epoch_counter.limit`）。当迭代满额时循环自然退出，随后打印 `"Training finisihed"` 并返回最终扰动。这说明日志在 epoch 100 停止，是因为达到设定的总轮数而不是异常中断。
- 每个 epoch 结束时会在进度条后缀里更新当前/最佳成功率，并在退出时打印“Best success rate”。这些数值来自周期性成功率评估，而非单个 batch 的即时指标。

## 日志里“成功率/损失”的含义
- 训练时每隔 `success_every` 轮（命令行/配置项）触发一次成功率检查：对当前扰动依次生成对抗样本，统计 `fooled_sample/total_sample` 得到成功率，同时求平均损失并在最佳时保存 checkpoint。因此日志中的 `Check success rate after epoch 100` 与 `SUCCESS RATE IS 0.0149` 反映的是该轮的全量评估结果。
- 进度条中的 `δ∞`、`pgd_steps`、`ema_total/ema_lang` 等字段都来自每个 batch 的记录，分别对应当前扰动的 L∞ 范数、实际运行的 PGD 步数，以及总损失/语言损失的滑动平均，便于观察训练是否稳定。

## SNR 数值异常的原因与解读
- 每个 batch 会计算信噪比 `SNR(dB)=10*log10(signal_power/noise_power)`。当噪声功率接近 0（如扰动已被强约束）时，分母极小会导致 SNR 非常大或为无穷大；反之噪声大于信号则会得到负值。
- 评估阶段会对所有样本的 SNR 取平均/最小/最大；若个别样本出现极端值（如无穷大或浮点溢出），累计平均可能出现非常大的正负数。日志中同时出现 `max_score` 极大、`average` 为巨负值，通常就是这些极端 SNR 拉坏了整体统计，而非模型崩溃。
- 若希望得到更平滑的 SNR 统计，可以减小 `eps` 或 `nb_iter` 让扰动幅度更均衡，或在分析时过滤掉无穷大/异常值再做平均。
